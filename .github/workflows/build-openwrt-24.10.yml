name: Build OpenWrt 24.10.4 for ZBT-Z8102AX-eMMC

on:
  workflow_dispatch:
    inputs:
      clean_build:
        description: '清除构建缓存'
        required: false
        default: 'false'
      skip_download:
        description: '跳过下载阶段'
        required: false
        default: 'false'

env:
  OPENWRT_VERSION: "24.10.4"
  OPENWRT_BRANCH: "openwrt-24.10"
  TARGET: "mediatek"
  SUBTARGET: "filogic"
  DEVICE: "zbtlink_z8102ax-emmc"

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    
    steps:
    # 第一步：检出仓库（默认检出到当前目录）
    - name: 检出仓库内容
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # 第二步：显示实际文件结构
    - name: 验证文件结构
      run: |
        echo "=== 仓库文件结构 ==="
        echo "当前目录: $(pwd)"
        echo ""
        echo "查找关键文件:"
        echo "1. DTS文件:"
        find . -name "mt7981b-zbt-z8102ax-emmc.dts" -type f 2>/dev/null || echo "未找到"
        echo ""
        echo "2. Config文件:"
        find . -name "zbtlink_z8102ax-emmc.config" -type f 2>/dev/null || echo "未找到"
        echo ""
        echo "3. MK文件:"
        find . -name "filogic.mk" -type f 2>/dev/null || echo "未找到"
        echo ""
        echo "custom-configs目录内容:"
        ls -la custom-configs/ || echo "custom-configs目录不存在"

    # 第三步：设置编译环境
    - name: 设置构建环境
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential ccache ecj fastjar file g++ gawk gettext git \
          libelf-dev libncurses5-dev libncursesw5-dev libssl-dev \
          python3 python3-setuptools python3-dev rsync unzip wget \
          xsltproc zlib1g-dev cmake pkg-config flex bison

        sudo mkdir -p /opt/ccache
        sudo chmod 777 /opt/ccache
        echo "CCACHE_DIR=/opt/ccache" >> $GITHUB_ENV
        echo "/usr/lib/ccache" >> $GITHUB_PATH
        ccache -M 10G

    # 第四步：克隆OpenWrt源码
    - name: 克隆 OpenWrt 源码
      run: |
        echo "正在克隆 OpenWrt ${{ env.OPENWRT_BRANCH }} 分支..."
        
        git clone https://git.openwrt.org/openwrt/openwrt.git \
          --branch ${{ env.OPENWRT_BRANCH }} \
          --single-branch \
          --depth=1 \
          openwrt-build

        cd openwrt-build
        git submodule update --init --recursive

    # 第五步：应用自定义配置文件（使用您的实际路径）
    - name: 应用自定义配置
      run: |
        cd openwrt-build
        
        echo "=== 应用自定义配置文件 ==="
        
        # 您的实际文件路径（根据您的文件结构）
        DTS_FILE="../custom-configs/dts/mt7981b-zbt-z8102ax-emmc.dts"
        CONFIG_FILE="../custom-configs/configs/zbtlink_z8102ax-emmc.config"
        MK_FILE="../custom-configs/target/linux/mediatek/image/filogic.mk"
        
        echo "检查文件是否存在:"
        echo "DTS文件: $DTS_FILE - $( [ -f "$DTS_FILE" ] && echo '存在' || echo '不存在' )"
        echo "Config文件: $CONFIG_FILE - $( [ -f "$CONFIG_FILE" ] && echo '存在' || echo '不存在' )"
        echo "MK文件: $MK_FILE - $( [ -f "$MK_FILE" ] && echo '存在' || echo '不存在' )"
        
        # 1. 复制DTS文件
        if [ -f "$DTS_FILE" ]; then
          echo "复制DTS文件..."
          mkdir -p target/linux/${{ env.TARGET }}/dts/
          cp "$DTS_FILE" target/linux/${{ env.TARGET }}/dts/
          echo "✅ DTS文件已复制"
        else
          echo "❌ 错误：DTS文件不存在: $DTS_FILE"
          exit 1
        fi
        
        # 2. 复制MK文件
        if [ -f "$MK_FILE" ]; then
          echo "复制MK文件..."
          mkdir -p target/linux/${{ env.TARGET }}/image/
          cp "$MK_FILE" target/linux/${{ env.TARGET }}/image/
          echo "✅ MK文件已复制"
        else
          echo "⚠️ 警告：MK文件不存在，使用默认配置"
        fi
        
        # 3. 准备config文件
        if [ -f "$CONFIG_FILE" ]; then
          echo "准备config文件..."
          cp "$CONFIG_FILE" device-config.config
          echo "✅ Config文件已准备"
        else
          echo "❌ 错误：Config文件不存在: $CONFIG_FILE"
          exit 1
        fi

    # 第六步：更新和安装软件源
    - name: 更新和安装软件源
      run: |
        cd openwrt-build
        
        echo "更新软件源..."
        ./scripts/feeds update -a
        
        echo "安装软件包..."
        ./scripts/feeds install -a

    # 第七步：配置OpenWrt
    - name: 配置 OpenWrt
      run: |
        cd openwrt-build
        
        # 清理选项
        if [[ "${{ github.event.inputs.clean_build }}" == "true" ]]; then
          echo "执行清理..."
          make clean
        fi
        
        # 生成默认配置
        make defconfig
        
        # 应用基础配置
        echo "CONFIG_TARGET_mediatek=y" >> .config
        echo "CONFIG_TARGET_mediatek_filogic=y" >> .config
        echo "CONFIG_TARGET_mediatek_filogic_DEVICE_zbtlink_z8102ax-emmc=y" >> .config
        
        # 应用自定义配置文件
        if [ -f "device-config.config" ]; then
          echo "应用自定义配置文件..."
          cat device-config.config >> .config
          echo "✅ 自定义配置文件已应用"
          
          # 检查是否已包含必要配置
          if grep -q "CONFIG_TARGET_mediatek_filogic_DEVICE_zbtlink_z8102ax-emmc=y" .config; then
            echo "✅ 设备配置已正确设置"
          else
            echo "⚠️ 警告：设备配置可能未在自定义配置中设置"
          fi
        else
          echo "❌ 错误：自定义配置文件不存在"
          exit 1
        fi
        
        # 验证配置
        make defconfig
        
        echo "=== 配置验证 ==="
        echo "设备配置状态:"
        grep -i "zbtlink\|z8102ax" .config || echo "未找到设备相关配置"

    # 第八步：下载软件包源码
    - name: 下载软件包源码
      if: github.event.inputs.skip_download != 'true'
      run: |
        cd openwrt-build
        echo "下载软件包源码..."
        make download -j$(nproc) || make download -j1

    # 第九步：编译OpenWrt
    - name: 编译 OpenWrt
      run: |
        cd openwrt-build
        
        echo "开始编译 OpenWrt ${{ env.OPENWRT_VERSION }}..."
        echo "目标设备: ${{ env.DEVICE }}"
        
        START_TIME=$(date +%s)
        
        # 编译（使用单线程便于调试）
        echo "开始编译过程..."
        time make -j1 V=s 2>&1 | tee build.log
        
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        
        echo "编译耗时: $((DURATION / 60))分$((DURATION % 60))秒"
        
        # 验证构建结果
        FIRMWARE_DIR="bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}"
        
        if [ -d "$FIRMWARE_DIR" ]; then
          echo "产出目录内容:"
          ls -la "$FIRMWARE_DIR/"
          
          BIN_FILES=$(find "$FIRMWARE_DIR" -name "*.bin" -type f 2>/dev/null)
          BIN_COUNT=$(echo "$BIN_FILES" | wc -l 2>/dev/null || echo 0)
          
          if [ "$BIN_COUNT" -gt 0 ]; then
            echo "✅ 编译成功！生成 $BIN_COUNT 个固件文件"
            echo "$BIN_FILES" | head -5 | while read f; do
              echo "  - $(basename "$f") ($(ls -lh "$f" | awk '{print $5}'))"
            done
          else
            echo "❌ 编译完成但未生成固件文件"
            echo "请检查 build.log 文件末尾的错误信息"
            exit 1
          fi
        else
          echo "❌ 产出目录不存在: $FIRMWARE_DIR"
          exit 1
        fi

    # 第十步：上传产物
    - name: 上传固件产物
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-${{ env.OPENWRT_VERSION }}-${{ env.DEVICE }}
        path: |
          openwrt-build/bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}/*.bin
          openwrt-build/bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}/sha256sums
        if-no-files-found: error

    - name: 上传编译日志
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-${{ env.OPENWRT_VERSION }}-logs
        path: |
          openwrt-build/build.log
          openwrt-build/.config
          openwrt-build/device-config.config
        if-no-files-found: warn
